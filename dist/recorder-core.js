/*
录音
https://github.com/xiangyuecn/Recorder
src: recorder-core.js
*/
!function(I){"use strict";var m=function(){},P=function(e){return new t(e)};P.LM="2023-02-01 18:05";var L="Recorder",S="getUserMedia",W="srcSampleRate",E="sampleRate",A="catch";P.IsOpen=function(){var e=P.Stream;if(e){var t=e.getTracks&&e.getTracks()||e.audioTracks||[],n=t[0];if(n){var r=n.readyState;return"live"==r||r==n.LIVE}}return!1},P.BufferSize=4096,P.Destroy=function(){for(var e in O(L+" Destroy"),_(),n)n[e]()};var n={};P.BindDestroy=function(e,t){n[e]=t},P.Support=function(){var e=navigator.mediaDevices||{};return e[S]||(e=navigator)[S]||(e[S]=e.webkitGetUserMedia||e.mozGetUserMedia||e.msGetUserMedia),!!e[S]&&(P.Scope=e,!!P.GetContext())},P.GetContext=function(){var e=I.AudioContext;return e||(e=I.webkitAudioContext),e?(P.Ctx&&"closed"!=P.Ctx.state||(P.Ctx=new e,P.BindDestroy("Ctx",function(){var e=P.Ctx;e&&e.close&&(e.close(),P.Ctx=0)})),P.Ctx):null};var D="ConnectEnableWebM";P[D]=!0;var T="ConnectEnableWorklet";P[T]=!1;var C=function(e,c){var f,i,u,l=e.BufferSize||P.BufferSize,v=P.Ctx,h=e.Stream,s=function(e){var t=h._m=v.createMediaStreamSource(h),n=v.destination,r="createMediaStreamDestination";v[r]&&(n=v[r]()),t.connect(e),e.connect(n)},p="",g=h._call,d=function(e,t){for(var n in g){for(var r=t.length,a=new Int16Array(r),o=0,i=0;i<r;i++){var s=Math.max(-1,Math.min(1,t[i]));s=s<0?32768*s:32767*s,a[i]=s,o+=Math.abs(s)}for(var c in g)g[c](a,o,e);return}},m="ScriptProcessor",S="audioWorklet",C=L+" "+S,_="RecProc",y="MediaRecorder",b=y+".WebM.PCM",k=v.createScriptProcessor||v.createJavaScriptNode,M="。由于"+S+"内部1秒375次回调，在移动端可能会有性能问题导致回调丢失录音变短，PC端无影响，暂不建议开启"+S+"。",x=function(){i=h.isWorklet=!1,z(h),O("Connect采用老的"+m+"，"+(P[T]?"但已":"可")+"设置"+L+"."+T+"=true尝试启用"+S+p+M,3);var e=h._p=k.call(v,l,1,1);s(e);var t="_D220626",n=P[t];n&&O("Use "+L+"."+t,3),e.onaudioprocess=function(e){var t=e.inputBuffer.getChannelData(0);n?(t=new Float32Array(t),setTimeout(function(){d(0,t)})):d(0,t)}},w=function(){f=h.isWebM=!1,F(h),i=h.isWorklet=!k||P[T];var t=I.AudioWorkletNode;if(i&&v[S]&&t){var r=function(){return i&&h._na},a=h._na=function(){""!==u&&(clearTimeout(u),u=setTimeout(function(){u=0,r()&&(O(S+"未返回任何音频，恢复使用"+m,3),k&&x())},500))},o=function(){if(r()){var e=h._n=new t(v,_,{processorOptions:{bufferSize:l}});s(e),e.port.onmessage=function(e){u&&(clearTimeout(u),u=""),r()?d(0,e.data.val):i||O(S+"多余回调",3)},O("Connect采用"+S+"，设置"+L+"."+T+"=false可恢复老式"+m+p+M,3)}};v.resume()[g&&"finally"](function(){if(r())if(v[_])o();else{var e,t,n=(t="class "+_+" extends AudioWorkletProcessor{",t+="constructor "+(e=function(e){return e.toString().replace(/^function|DEL_/g,"").replace(/\$RA/g,C)})(function(e){DEL_super(e);var t=this,n=e.processorOptions.bufferSize;t.bufferSize=n,t.buffer=new Float32Array(2*n),t.pos=0,t.port.onmessage=function(e){e.data.kill&&(t.kill=!0,console.log("$RA kill call"))},console.log("$RA .ctor call",e)}),t+="process "+e(function(e,t,n){var r=this,a=r.bufferSize,o=r.buffer,i=r.pos;if((e=(e[0]||[])[0]||[]).length){o.set(e,i);var s=~~((i+=e.length)/a)*a;if(s){this.port.postMessage({val:o.slice(0,s)});var c=o.subarray(s,i);(o=new Float32Array(2*a)).set(c),i=c.length,r.buffer=o}r.pos=i}return!r.kill}),t+='}try{registerProcessor("'+_+'", '+_+')}catch(e){console.error("'+C+'注册失败",e)}',"data:text/javascript;base64,"+btoa(unescape(encodeURIComponent(t))));v[S].addModule(n).then(function(e){r()&&(v[_]=1,o(),u&&a())})[A](function(e){O(S+".addModule失败",1,e),r()&&x()})}})}else x()};!function(){var e=I[y],t="ondataavailable",n="audio/webm; codecs=pcm";f=h.isWebM=P[D];var r=e&&t in e.prototype&&e.isTypeSupported(n);if(p=r?"":"（此浏览器不支持"+b+"）",!c||!f||!r)return w();var a=function(){return f&&h._ra},o=(h._ra=function(){""!==u&&(clearTimeout(u),u=setTimeout(function(){a()&&(O(y+"未返回任何音频，降级使用"+S,3),w())},500))},Object.assign({mimeType:n},P.ConnectWebMOptions)),i=h._r=new e(h,o),s=h._rd={sampleRate:v[E]};i[t]=function(e){var n=new FileReader;n.onloadend=function(){if(a()){var e=R(new Uint8Array(n.result),s);if(!e)return;if(-1==e)return void w();u&&(clearTimeout(u),u="");for(var t=0;t<e.length;t++)d(t,e[t])}else f||O(y+"多余回调",3)},n.readAsArrayBuffer(e.data)},i.start(~~(l/48)),O("Connect采用"+b+"，设置"+L+"."+D+"=false可恢复使用"+S+"或老式"+m)}()},z=function(e){e._na=null,e._n&&(e._n.port.postMessage({kill:!0}),e._n.disconnect(),e._n=null)},F=function(e){e._ra=null,e._r&&(e._r.stop(),e._r=null)},_=function(e){var t=(e=e||P)==P,n=e.Stream;if(n&&(n._m&&(n._m.disconnect(),n._m=null),n._p&&(n._p.disconnect(),n._p.onaudioprocess=n._p=null),z(n),F(n),t)){for(var r=n.getTracks&&n.getTracks()||n.audioTracks||[],a=0;a<r.length;a++){var o=r[a];o.stop&&o.stop()}n.stop&&n.stop()}e.Stream=0};P.SampleData=function(e,t,n,r,a){r||(r={});var o=r.index||0,i=r.offset||0,s=r.frameNext||[];a||(a={});var c=a.frameSize||1;a.frameType&&(c="mp3"==a.frameType?1152:1);var f=e.length;f+1<o&&O("SampleData似乎传入了未重置chunk "+o+">"+f,3);for(var u=0,l=o;l<f;l++)u+=e[l].length;u=Math.max(0,u-Math.floor(i));var v=t/n;1<v?u=Math.floor(u/v):(v=1,n=t),u+=s.length;for(var h=new Int16Array(u),p=0,l=0;l<s.length;l++)h[p]=s[l],p++;for(;o<f;o++){for(var g=e[o],l=i,d=g.length;l<d;){var m=Math.floor(l),S=Math.ceil(l),C=l-m,_=g[m],y=S<d?g[S]:(e[o+1]||[_])[0]||0;h[p]=_+(y-_)*C,p++,l+=v}i=l-d}s=null;var b=h.length%c;if(0<b){var k=2*(h.length-b);s=new Int16Array(h.buffer.slice(k)),h=new Int16Array(h.buffer.slice(0,k))}return{index:o,offset:i,frameNext:s,sampleRate:n,data:h}},P.PowerLevel=function(e,t){var n=e/t||0;return n<1251?Math.round(n/1250*10):Math.round(Math.min(100,Math.max(0,100*(1+Math.log(n/1e4)/Math.log(10)))))},P.PowerDBFS=function(e){var t=Math.max(.1,e||0);return t=Math.min(t,32767),t=20*Math.log(t/32767)/Math.log(10),Math.max(-100,Math.round(t))},P.CLog=function(e,t){var n=new Date,r=("0"+n.getMinutes()).substr(-2)+":"+("0"+n.getSeconds()).substr(-2)+"."+("00"+n.getMilliseconds()).substr(-3),a=this&&this.envIn&&this.envCheck&&this.id,o=["["+r+" "+L+(a?":"+a:"")+"]"+e],i=arguments,s=I.console||{},c=2,f=s.log;for("number"==typeof t?f=1==t?s.error:3==t?s.warn:f:c=1;c<i.length;c++)o.push(i[c]);u?f&&f("[IsLoser]"+o[0],1<o.length?o:""):f.apply(s,o)};var O=function(){P.CLog.apply(this,arguments)},u=!0;try{u=!console.log.apply}catch(e){}var r=0;function t(e){this.id=++r,o();var t={type:"mp3",bitRate:16,sampleRate:16e3,channelNo:0,onProcess:m};for(var n in e)t[n]=e[n];this.set=t,this._S=9,this.Sync={O:9,C:9}}P.Sync={O:9,C:9},P.prototype=t.prototype={CLog:O,_streamStore:function(){return this.set.sourceStream?this:P},open:function(e,n){var r=this,a=r._streamStore();e=e||m;var o=function(e,t){t=!!t,r.CLog("录音open失败："+e+",isUserNotAllow:"+t,1),n&&n(e,t)},i=function(){r.CLog("open ok id:"+r.id),e(),r._SO=0},s=a.Sync,c=++s.O,f=s.C;r._O=r._O_=c,r._SO=r._S;var t=r.envCheck({envName:"H5",canProcess:!0});if(t)o("不能录音："+t);else if(r.set.sourceStream){if(!P.GetContext())return void o("不支持此浏览器从流中获取录音");_(a),r.Stream=r.set.sourceStream,r.Stream._call={};try{C(a)}catch(e){return void o("从流中打开录音失败："+e.message)}i()}else{var u=function(e,t){try{I.top.a}catch(e){return void o('无权录音(跨域，请尝试给iframe添加麦克风访问策略，如allow="camera;microphone")')}/Permission|Allow/i.test(e)?o("用户拒绝了录音权限",!0):!1===I.isSecureContext?o("浏览器禁止不安全页面录音，可开启https解决"):/Found/i.test(e)?o(t+"，无可用麦克风"):o(t)};if(P.IsOpen())i();else if(P.Support()){var l=function(t){setTimeout(function(){t._call={};var e=P.Stream;e&&(_(),t._call=e._call),P.Stream=t,function(){if(f!=s.C||!r._O){var e="open被取消";return c==s.O?r.close():e="open被中断",o(e),!0}}()||(P.IsOpen()?(e&&r.CLog("发现同时多次调用open",1),C(a,1),i()):o("录音功能无效：无音频流"))},100)},v=function(e){var t=e.name||e.message||e.code+":"+e;r.CLog("请求录音权限错误",1,e),u(t,"无法录音："+t)},h={noiseSuppression:!1,echoCancellation:!1},p=r.set.audioTrackSet;for(var g in p)h[g]=p[g];h.sampleRate=P.Ctx.sampleRate;try{var d=P.Scope[S]({audio:h},l,v)}catch(e){r.CLog(S,3,e),d=P.Scope[S]({audio:!0},l,v)}d&&d.then&&d.then(l)[A](v)}else u("","此浏览器不支持录音")}},close:function(e){e=e||m;var t=this,n=t._streamStore();t._stop();var r=n.Sync;if(t._O=0,t._O_!=r.O)return t.CLog("close被忽略（因为同时open了多个rec，只有最后一个会真正close）",3),void e();r.C++,_(n),t.CLog("close"),e()},mock:function(e,t){var n=this;return n._stop(),n.isMock=1,n.mockEnvInfo=null,n.buffers=[e],n.recSize=e.length,n[W]=t,n},envCheck:function(e){var t,n=this.set,r="CPU_BE";if(t||P[r]||!I.Int8Array||new Int8Array(new Int32Array([1]).buffer)[0]||(o(r),t="不支持CPU_BE架构"),!t){var a=n.type;this[a+"_envCheck"]?t=this[a+"_envCheck"](e,n):n.takeoffEncodeChunk&&(t=a+"类型"+(this[a]?"":"(未加载编码器)")+"不支持设置takeoffEncodeChunk")}return t||""},envStart:function(e,t){var n=this,r=n.set;n.isMock=e?1:0,n.mockEnvInfo=e,n.buffers=[],n.recSize=0,n.envInLast=0,n.envInFirst=0,n.envInFix=0,n.envInFixTs=[];var a=r[E];if(t<a?r[E]=t:a=0,n[W]=t,n.CLog(W+": "+t+" set."+E+": "+r[E]+(a?" 忽略"+a:""),a?3:0),n.engineCtx=0,n[r.type+"_start"]){var o=n.engineCtx=n[r.type+"_start"](r);o&&(o.pcmDatas=[],o.pcmSize=0)}},envResume:function(){this.envInFixTs=[]},envIn:function(e,t){var a=this,o=a.set,i=a.engineCtx,n=a[W],r=e.length,s=P.PowerLevel(t,r),c=a.buffers,f=c.length;c.push(e);var u=c,l=f,v=Date.now(),h=Math.round(r/n*1e3);a.envInLast=v,1==a.buffers.length&&(a.envInFirst=v-h);var p=a.envInFixTs;p.splice(0,0,{t:v,d:h});for(var g=v,d=0,m=0;m<p.length;m++){var S=p[m];if(3e3<v-S.t){p.length=m;break}g=S.t,d+=S.d}var C=p[1],_=v-g;if(_/3<_-d&&(C&&1e3<_||6<=p.length)){var y=v-C.t-h;if(h/5<y){var b=!o.disableEnvInFix;if(a.CLog("["+v+"]"+(b?"":"未")+"补偿"+y+"ms",3),a.envInFix+=y,b){var k=new Int16Array(y*n/1e3);r+=k.length,c.push(k)}}}var M=a.recSize,x=r,w=M+x;if(a.recSize=w,i){var I=P.SampleData(c,n,o[E],i.chunkInfo);i.chunkInfo=I,w=(M=i.pcmSize)+(x=I.data.length),i.pcmSize=w,c=i.pcmDatas,f=c.length,c.push(I.data),n=I[E]}var L=Math.round(w/n*1e3),A=c.length,D=u.length,T=function(){for(var e=z?0:-x,t=null==c[0],n=f;n<A;n++){var r=c[n];null==r?t=1:(e+=r.length,i&&r.length&&a[o.type+"_encode"](i,r))}if(t&&i)for(n=l,u[0]&&(n=0);n<D;n++)u[n]=null;t&&(e=z?x:0,c[0]=null),i?i.pcmSize+=e:a.recSize+=e},z=0,F="rec.set.onProcess";try{z=o.onProcess(c,s,L,n,f,T)}catch(e){console.error(F+"回调出错是不允许的，需保证不会抛异常",e)}var O=Date.now()-v;if(10<O&&1e3<a.envInFirst-v&&a.CLog(F+"低性能，耗时"+O+"ms",3),!0===z){var R=0;for(m=f;m<A;m++)null==c[m]?R=1:c[m]=new Int16Array(0);R?a.CLog("未进入异步前不能清除buffers",3):i?i.pcmSize-=x:a.recSize-=x}else T()},start:function(){var t=this,n=P.Ctx,e=1;if(t.set.sourceStream?t.Stream||(e=0):P.IsOpen()||(e=0),e)if(t.CLog("开始录音"),t._stop(),t.state=3,t.envStart(null,n[E]),t._SO&&t._SO+1!=t._S)t.CLog("start被中断",3);else{t._SO=0;var r=function(){3==t.state&&(t.state=1,t.resume())};if("suspended"==n.state){var a="AudioContext resume: ";t.CLog(a+"wait..."),n.resume().then(function(){t.CLog(a+n.state),r()})[A](function(e){t.CLog(a+n.state+" 可能无法录音："+e.message,1,e),r()})}else r()}else t.CLog("未open",1)},pause:function(){var e=this;e.state&&(e.state=2,e.CLog("pause"),delete e._streamStore().Stream._call[e.id])},resume:function(){var e,r=this;if(r.state){r.state=1,r.CLog("resume"),r.envResume();var t=r._streamStore().Stream;t._call[r.id]=function(e,t,n){1==r.state&&r.set.channelNo===n&&r.envIn(e,t)},(e=t)._na&&e._na(),e._ra&&e._ra()}},_stop:function(e){var t=this,n=t.set;t.isMock||t._S++,t.state&&(t.pause(),t.state=0),!e&&t[n.type+"_stop"]&&(t[n.type+"_stop"](t.engineCtx),t.engineCtx=0)},stop:function(n,t,e){var r,a=this,o=a.set,i=a.envInLast-a.envInFirst,s=i&&a.buffers.length;a.CLog("stop 和start时差"+(i?i+"ms 补偿"+a.envInFix+"ms envIn:"+s+" fps:"+(s/i*1e3).toFixed(1):"-"));var c=function(){a._stop(),e&&a.close()},f=function(e){a.CLog("结束录音失败："+e,1),t&&t(e),c()},u=function(e,t){if(a.CLog("结束录音 编码花"+(Date.now()-r)+"ms 音频时长"+t+"ms 文件大小"+e.size+"b"),o.takeoffEncodeChunk)a.CLog("启用takeoffEncodeChunk后stop返回的blob长度为0不提供音频数据",3);else if(e.size<Math.max(100,t/2))return void f("生成的"+o.type+"无效");n&&n(e,t),c()};if(!a.isMock){var l=3==a.state;if(!a.state||l)return void f("未开始录音"+(l?"，开始录音前无用户交互导致AudioContext未运行":""));a._stop(!0)}var v=a.recSize;if(v)if(a.buffers[0])if(a[o.type]){if(a.isMock){var h=a.envCheck(a.mockEnvInfo||{envName:"mock",canProcess:!1});if(h)return void f("录音错误："+h)}var p=a.engineCtx;if(a[o.type+"_complete"]&&p){var g=Math.round(p.pcmSize/o[E]*1e3);return r=Date.now(),void a[o.type+"_complete"](p,function(e){u(e,g)},f)}r=Date.now();var d=P.SampleData(a.buffers,a[W],o[E]);o[E]=d[E];var m=d.data;g=Math.round(m.length/o[E]*1e3),a.CLog("采样"+v+"->"+m.length+" 花:"+(Date.now()-r)+"ms"),setTimeout(function(){r=Date.now(),a[o.type](m,function(e){u(e,g)},function(e){f(e)})})}else f("未加载"+o.type+"编码器");else f("音频buffers被释放");else f("未采集到录音")}},I[L]&&(O("重复引入"+L,3),I[L].Destroy()),I[L]=P;var R=function(e,t){t.pos||(t.pos=[0],t.tracks={},t.bytes=[]);var n=t.tracks,r=[t.pos[0]],a=function(){t.pos[0]=r[0]},o=t.bytes.length,i=new Uint8Array(o+e.length);if(i.set(t.bytes),i.set(e,o),t.bytes=i,!t._ht){if(N(i,r),G(i,r),!U(N(i,r),[24,83,128,103]))return;for(N(i,r);r[0]<i.length;){var s=N(i,r),c=G(i,r),f=[0],u=0;if(!c)return;if(U(s,[22,84,174,107])){for(;f[0]<c.length;){var l=N(c,f),v=G(c,f),h=[0],p={channels:0,sampleRate:0};if(U(l,[174]))for(;h[0]<v.length;){var g=N(v,h),d=G(v,h),m=[0];if(U(g,[215])){var S=B(d);p.number=S,n[S]=p}else if(U(g,[131])){var S=B(d);1==S?p.type="video":2==S?(p.type="audio",u||(t.track0=p),p.idx=u++):p.type="Type-"+S}else if(U(g,[134])){for(var C="",_=0;_<d.length;_++)C+=String.fromCharCode(d[_]);p.codec=C}else if(U(g,[225]))for(;m[0]<d.length;){var y=N(d,m),b=G(d,m);if(U(y,[181])){var S=0,k=new Uint8Array(b.reverse()).buffer;4==b.length?S=new Float32Array(k)[0]:8==b.length?S=new Float64Array(k)[0]:O("WebM Track !Float",1,b),p[E]=Math.round(S)}else U(y,[98,100])?p.bitDepth=B(b):U(y,[159])&&(p.channels=B(b))}}}t._ht=1,O("WebM Tracks",n),a();break}}}var M=t.track0;if(M){if(16==M.bitDepth&&/FLOAT/i.test(M.codec)&&(M.bitDepth=32,O("WebM 16改32位",3)),M[E]!=t[E]||32!=M.bitDepth||M.channels<1||!/(\b|_)PCM\b/i.test(M.codec))return t.bytes=[],t.bad||O("WebM Track非预期",3,t),-(t.bad=1);for(var x=[],w=0;r[0]<i.length;){var l=N(i,r),v=G(i,r);if(!v)break;if(U(l,[163])){var I=15&v[0],p=n[I];if(p){if(0===p.idx){for(var L=new Uint8Array(v.length-4),_=4;_<v.length;_++)L[_-4]=v[_];x.push(L),w+=L.length}}else O("WebM !Track"+I,1,n)}a()}if(w){var A=new Uint8Array(i.length-t.pos[0]);A.set(i.subarray(t.pos[0])),t.bytes=A,t.pos[0]=0;for(var L=new Uint8Array(w),_=0,D=0;_<x.length;_++)L.set(x[_],D),D+=x[_].length;var k=new Float32Array(L.buffer),T=[];if(1===M.channels)T.push(k);else for(var z=0;z<M.channels;z++){for(var F=[],_=0;_<k.length;)F.push(k[_+z]),_+=M.channels;T.push(new Float32Array(F))}return T}}},U=function(e,t){if(!e||e.length!=t.length)return!1;if(1==e.length)return e[0]==t[0];for(var n=0;n<e.length;n++)if(e[n]!=t[n])return!1;return!0},B=function(e){for(var t="",n=0;n<e.length;n++){var r=e[n];t+=(r<16?"0":"")+r.toString(16)}return parseInt(t,16)||0},N=function(e,t,n){var r=t[0];if(!(r>=e.length)){var a=e[r],o=("0000000"+a.toString(2)).substr(-8),i=/^(0*1)(\d*)$/.exec(o);if(i){var s=i[1].length,c=[];if(!(r+s>e.length)){for(var f=0;f<s;f++)c[f]=e[r],r++;return n&&(c[0]=parseInt(i[2]||"0",2)),t[0]=r,c}}}},G=function(e,t){var n=N(e,t,1);if(n){var r=B(n),a=t[0],o=[];if(r<2147483647){if(a+r>e.length)return;for(var i=0;i<r;i++)o[i]=e[a],a++}return t[0]=a,o}},o=P.Traffic=function(e){}}(window),"function"==typeof define&&define.amd&&define(function(){return Recorder}),"object"==typeof module&&module.exports&&(module.exports=Recorder);